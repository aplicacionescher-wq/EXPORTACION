<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario de Retorno - ANAM</title>

<style>
body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background-color: #f1f1f1;
    padding: 20px;
}

.container {
    background: white;
    padding: 30px;
    max-width: 800px;
    margin: auto;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.08);
    border-top: 8px solid #6A0F49; /* vino institucional */
}

.header {
    text-align: center;
    margin-bottom: 20px;
}

.header img {
    max-height: 80px;
}

.header h2 {
    color: #6A0F49;
    margin-top: 10px;
}

.info {
    background: #f7f7f7;
    padding: 12px;
    border-left: 4px solid #6A0F49;
    margin-bottom: 20px;
}

label {
    font-weight: 600;
    color: #333;
}

select, textarea, input {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 18px;
    border-radius: 4px;
    border: 1px solid #ccc;
}

button {
    background-color: #6A0F49;
    color: white;
    padding: 12px;
    border: none;
    width: 100%;
    cursor: pointer;
    font-size: 16px;
    border-radius: 4px;
}

button:hover {
    background-color: #4e0b36;
}

.hidden {
    display: none;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
    <img src="logo.png" alt="Logo ANAM">
    <h2>Formulario Institucional de Retorno</h2>
</div>

<div class="info">
    <strong>Folio:</strong> <span id="folio"></span><br>
    <strong>Fecha y Hora:</strong> <span id="fechaHora"></span>
</div>

<form id="formRetorno">

<label>Nombre del Operador en Turno:</label>
<input type="text" id="operador" required>

<label>Seleccione una opción:</label>
<select id="tipo" required>
    <option value="">-- Seleccione --</option>
    <option>Retorno Para Nueva Exploración</option>
    <option>Retorno Fuera De Horario</option>
    <option>Retorno Sin Servicio Extraordinario</option>
    <option>Retorno Por Equivocación de Carril</option>
    <option>Solicitud de Revisión De Mercancía Sobre-Dimensionada</option>
</select>

<label>Placa(s) del vehículo:</label>
<textarea id="placas" placeholder="Puede separar con coma, espacio o salto de línea" required></textarea>

<div id="mercanciaDiv" class="hidden">
    <label>Tipo de Mercancía / Descripción:</label>
    <textarea id="mercancia"></textarea>
</div>

<button type="submit">Enviar Correo</button>

</form>
</div>

<script>
function generarFolio() {
    const hoy = new Date();
    const fechaBase = hoy.getFullYear().toString() +
        ("0" + (hoy.getMonth()+1)).slice(-2) +
        ("0" + hoy.getDate()).slice(-2);

    let contador = localStorage.getItem("contador_" + fechaBase);
    if (!contador) contador = 1;
    else contador = parseInt(contador) + 1;

    localStorage.setItem("contador_" + fechaBase, contador);

    return "RET-" + fechaBase + "-" + String(contador).padStart(3,'0');
}

function inicializarFolio() {
    const hoy = new Date();
    const fechaBase = hoy.getFullYear().toString() +
        ("0" + (hoy.getMonth()+1)).slice(-2) +
        ("0" + hoy.getDate()).slice(-2);

    let contador = localStorage.getItem("contador_" + fechaBase);
    if (!contador) contador = 0;

    document.getElementById("folio").textContent =
        "RET-" + fechaBase + "-" + String(parseInt(contador)+1).padStart(3,'0');
}

function actualizarFechaHora() {
    document.getElementById("fechaHora").textContent = new Date().toLocaleString();
}

actualizarFechaHora();
setInterval(actualizarFechaHora, 1000);
inicializarFolio();

// Autodetectar nombre del usuario del navegador
document.getElementById("operador").value = navigator.userAgentData?.platform || "";

// Mostrar campo mercancía
document.getElementById("tipo").addEventListener("change", function() {
    if (this.value === "Solicitud de Revisión De Mercancía Sobre-Dimensionada") {
        document.getElementById("mercanciaDiv").classList.remove("hidden");
    } else {
        document.getElementById("mercanciaDiv").classList.add("hidden");
    }
});

document.getElementById("formRetorno").addEventListener("submit", function(e) {
    e.preventDefault();

    const operador = document.getElementById("operador").value.trim();
    const tipo = document.getElementById("tipo").value;
    let placas = document.getElementById("placas").value.trim();
    const mercancia = document.getElementById("mercancia").value.trim();

    if (!operador || !tipo || !placas) {
        alert("Todos los campos obligatorios deben llenarse.");
        return;
    }

    if (tipo === "Solicitud de Revisión De Mercancía Sobre-Dimensionada" && !mercancia) {
        alert("Debe ingresar la descripción de la mercancía.");
        return;
    }

    // Separación automática por renglón
    placas = placas
        .replace(/,/g, '\n')
        .replace(/\s+/g, '\n')
        .split('\n')
        .filter(p => p.trim() !== "")
        .join('\n');

    const folio = generarFolio();
    document.getElementById("folio").textContent = folio;

    let cuerpo =
`FOLIO: ${folio}
Fecha y Hora: ${document.getElementById("fechaHora").textContent}
Operador en Turno: ${operador}

Tipo de Solicitud:
${tipo}

Placa(s):
${placas}
`;

    if (tipo === "Solicitud de Revisión De Mercancía Sobre-Dimensionada") {
        cuerpo += `

Tipo de Mercancía:
${mercancia}
`;
    }

    const destinatarios = "jorge.silva@anam.gob.mx;vyc.altamira@anam.gob.mx;alejandra.munoz@anam.gob.mx;nayely.chavez@anam.gob.mx;miguel.herrera@anam.gob.mx;abraham.gomez@anam.gob.mx;daniel.santosh@anam.gob.mx;christian.monrreal@anam.gob.mx;monica.becerra@anam.gob.mx;anahi.santiago@anam.gob.mx";

    const mailtoLink = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(destinatarios)}&subject=${encodeURIComponent(tipo)}&body=${encodeURIComponent(cuerpo)}`;

    window.open(mailtoLink, '_blank');

    this.reset();
    document.getElementById("mercanciaDiv").classList.add("hidden");
    inicializarFolio();
});
</script>

</body>
</html>