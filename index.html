<script>
(function () {

const destinatarios = [
"jorge.silva@anam.gob.mx",
"vyc.altamira@anam.gob.mx",
"alejandra.munoz@anam.gob.mx",
"nayely.chavez@anam.gob.mx",
"miguel.herrera@anam.gob.mx",
"abraham.gomez@anam.gob.mx",
"daniel.santosh@anam.gob.mx",
"christian.monrreal@anam.gob.mx",
"monica.becerra@anam.gob.mx",
"anahi.santiago@anam.gob.mx"
];

const form = document.getElementById("formRetorno");
const submitBtn = form.querySelector("button[type='submit']");
const previewModal = document.getElementById("previewModal");

let estadoCorreo = {
    asunto: "",
    cuerpo: "",
    modoEnvio: ""
};

// ============================
// UTILIDADES
// ============================

function obtenerFechaBase() {
    const hoy = new Date();
    return hoy.getFullYear().toString() +
        ("0" + (hoy.getMonth()+1)).slice(-2) +
        ("0" + hoy.getDate()).slice(-2);
}

function generarFolio() {
    const fechaBase = obtenerFechaBase();
    let contador = localStorage.getItem("contador_" + fechaBase);

    contador = contador ? parseInt(contador) + 1 : 1;
    localStorage.setItem("contador_" + fechaBase, contador);

    return `RET-${fechaBase}-${String(contador).padStart(3,'0')}`;
}

function inicializarFolio() {
    const fechaBase = obtenerFechaBase();
    let contador = localStorage.getItem("contador_" + fechaBase);
    contador = contador ? parseInt(contador) + 1 : 1;

    document.getElementById("folio").textContent =
        `RET-${fechaBase}-${String(contador).padStart(3,'0')}`;
}

function actualizarFechaHora() {
    document.getElementById("fechaHora").textContent =
        new Date().toLocaleString();
}

// ============================
// VALIDACIÓN
// ============================

function validarFormulario() {
    const campos = form.querySelectorAll("[required]");
    let valido = true;

    campos.forEach(campo => {
        if (!campo.value.trim()) {
            valido = false;
        }
    });

    submitBtn.disabled = !valido;
}

// ============================
// EVENTOS
// ============================

form.addEventListener("input", validarFormulario);
form.addEventListener("change", validarFormulario);

document.getElementById("operacion").addEventListener("change", function () {
    const container = document.querySelector(".container");

    const colores = {
        "IMPORTACION": "#0055A4",
        "EXPORTACION": "#0A7F3F"
    };

    container.style.borderTop = `8px solid ${colores[this.value] || "#6A0F49"}`;
});

document.getElementById("placas").addEventListener("input", function () {
    this.value = this.value.toUpperCase();
});

document.getElementById("tipo").addEventListener("change", function () {
    const mercanciaDiv = document.getElementById("mercanciaDiv");
    mercanciaDiv.classList.toggle(
        "hidden",
        this.value !== "Solicitud de Revisión De Mercancía Sobre-Dimensionada"
    );
});

// ============================
// SUBMIT
// ============================

form.addEventListener("submit", function (e) {
    e.preventDefault();

    const operacion = document.getElementById("operacion").value;
    const operador = document.getElementById("operador").value.trim();
    const tipo = document.getElementById("tipo").value;
    const placas = document.getElementById("placas").value.trim();
    const mercancia = document.getElementById("mercancia").value.trim();
    const modoEnvio = document.getElementById("modoEnvio").value;

    const folio = generarFolio();
    document.getElementById("folio").textContent = folio;

    let cuerpo =
`FOLIO: ${folio}
Fecha y Hora: ${document.getElementById("fechaHora").textContent}
Operación: ${operacion}
Operador en Turno: ${operador}

Tipo de Solicitud:
${tipo}

Placa(s):
${placas}`;

    if (tipo === "Solicitud de Revisión De Mercancía Sobre-Dimensionada") {
        cuerpo += `

Tipo de Mercancía:
${mercancia}`;
    }

    estadoCorreo.asunto = `${operacion} - ${tipo}`;
    estadoCorreo.cuerpo = cuerpo;
    estadoCorreo.modoEnvio = modoEnvio;

    document.getElementById("previewDestinatarios").textContent =
        destinatarios.join("; ");

    document.getElementById("previewAsunto").textContent =
        estadoCorreo.asunto;

    document.getElementById("previewCuerpo").textContent =
        estadoCorreo.cuerpo;

    previewModal.classList.remove("hidden");
});

// ============================
// ENVÍO CONFIRMADO
// ============================

window.enviarCorreoConfirmado = function () {

    const to = encodeURIComponent(destinatarios.join(";"));
    const subject = encodeURIComponent(estadoCorreo.asunto);
    const body = encodeURIComponent(estadoCorreo.cuerpo);

    let enlace = "";

    if (estadoCorreo.modoEnvio === "web") {
        enlace = `https://outlook.office.com/mail/deeplink/compose?to=${to}&subject=${subject}&body=${body}`;
    } else {
        enlace = `mailto:${destinatarios.join(";")}?subject=${subject}&body=${body}`;
    }

    window.open(enlace, "_blank");

    previewModal.classList.add("hidden");
    form.reset();
    submitBtn.disabled = true;
    inicializarFolio();
};

window.cerrarPreview = function () {
    previewModal.classList.add("hidden");
};

// ============================
// INICIALIZACIÓN
// ============================

actualizarFechaHora();
setInterval(actualizarFechaHora, 1000);
inicializarFolio();
validarFormulario();

})();
</script>
